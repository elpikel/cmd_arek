<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="utf-8">
        <title>cmdarek.com - Using LiveView and Genservers to track cryptocurrency exchanges</title>

        <link rel="preconnect" href="https://fonts.gstatic.com">
        <link href="https://fonts.googleapis.com/css2?family=Bungee+Outline&family=Roboto+Mono:wght@500&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

        <link rel="stylesheet" href="../styles/hybrid.css">
        <script src="../js/highlight.pack.js"></script>
        <script>
            hljs.initHighlightingOnLoad();
        </script>

        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="Description" lang="en" content="">
        <meta name="author" content="">
        <meta name="robots" content="index, follow">

        <link rel="apple-touch-icon" href="../images/logo.svg">
        <link rel="shortcut icon" href="../images/logo.svg">
        <link rel="icon" href="images/logo.svg">

        <link rel="stylesheet" href="../styles/general.css">
    </head>

    <body>
        <div class="container">
            <div class="header">
                <a href="../index.html">
                    <img src="../images/logo.svg" alt="logo" />
                    <h1>cmdarek</h1>
                </a>
                <div>
                    <a target="_blank" href="https://twitter.com/el_pikel" class="fa fa-twitter"></a>
                    <a target="_blank" href="https://www.linkedin.com/in/arkadiusz-plichta-97a7a04b/" class="fa fa-linkedin"></a>
                </div>
            </div>
            <!--<div class="nav-bar">
                <ul class="nav">
                <li><a href="#">Nav item 1</a></li>
                </ul>
                </div> -->
                <div class="content">
                    <div class="main">
                        <span>01-01-2021</span>
                        <h2>Using LiveView and GenServers to track cryptocurrency exchanges</h2>

                        <p>My assumption was that price of Bitcoin varies from one cryptocurrecy exchange to another and that I could make $$$ just by buying and selling BTC on different platforms. In order to check that I could just get prices from last few days from few exchanges and use Excel to do the comparison or I could use this idea to improve my knowledge on LiveView and GenServers. As you have already guessed I picked latter option.</p>

                        <p><img src="../images/ebisu.svg" class="center"/></p>

                        <p>Our solution consist of two application: ebisu and ebisu_web. First one is responsible for periodically check BTC price in exchanges, saving fetched data in db and notifying ebisu_web about new pices. Ebisu_web is simple web application that shows BTC price from few exchanges in real time. To not add unnecessary complexity I'm going to describe solution only for bitbay.<p/>

                        <p><img src="../images/ebisu.gif" class="center"/></p>

                        <h3>Main components</h3>
                        <p>To fetch data from exchanges we use <a href="https://github.com/edgurgel/httpoison">HTTPoison</a> which is simple yet powerfull HTTP client. Ebisu.Utils.Http is wrapper around this library. It is done that way to reuse it in multiple places and to mock it in test. Ebisu.Bitbay.Clients.Http provides us with function to get data from exchange and exchange rate provider. We use it to calculate USD to PLN price.</p>                       
                        <pre>
                        <code class="elixir">
defmodule Ebisu.Utils.Http do
  @timeout 5000
  @callback get(String.t()) :: term() | no_return() | {:error, term()}

  def get(url) do
    case HTTPoison.get(url, [{"content-type", "application/json"}], recv_timeout: @timeout) do
      {:ok, %HTTPoison.Response{body: body, status_code: 200}} ->
        Jason.decode!(body)

      {:ok, %HTTPoison.Response{body: body}} ->
        {:error, body}

      {:error, %HTTPoison.Error{reason: reason}} ->
        {:error, reason}
    end
  end

  def new do
    Application.get_env(:ebisu, :http_client)
  end
end
                        </code>
                        <code class="elixir">
defmodule Ebisu.Bitbay.Clients.Http do
  alias Ebisu.Utils.Http

  # {"max":4500,"min":1465,"last":1533,"bid":1513,"ask":1542,"vwap":1524.42,"average":1545.67,"volume":4.54042857}
  def get_ticker do
    Http.new().get("https://bitbay.net/API/Public/BTCPLN/ticker.json")
  end

  def get_rate do
    rate = Http.new().get("http://api.nbp.pl/api/exchangerates/rates/a/usd/?format=json")

    rate
    |> Map.get("rates")
    |> Enum.at(0)
    |> Map.get("mid")
  end
end
                        </code> 
                        </pre>

                        <p>Heart of our application is exchange module which main responsibility is to get last price of BTC, converte it to USD and save it to db. Data is going to be stored in PostgreSQL using Ecto. For this to work we also have to define schema.</p>
                        <pre>
                        <code>
defmodule Ebisu.Bitbay do
  alias Ebisu.Bitbay.Clients.Http
  alias Ebisu.Bitbay.Ticker

  alias Ebisu.Repo

  import Ecto.Query

  def add_ticker do
    rate = Http.get_rate()

    Http.get_ticker()
    |> Map.put("rate", rate)
    |> Ticker.changeset()
    |> Repo.insert()
  end

  def tickers(limit \\ 20) do
    Ticker
    |> order_by(desc: :updated_at)
    |> limit(^limit)
    |> Repo.all()
  end
end
                        </code>
                        <code>
defmodule Ebisu.Bitbay.Ticker do
  use Ecto.Schema

  import Ecto.Changeset

  @fields [:max, :min, :last, :bid, :ask, :vwap, :average, :volume, :rate]

  schema "bitbay_tickers" do
    field(:max, :float)
    field(:min, :float)
    field(:last, :float)
    field(:bid, :float)
    field(:ask, :float)
    field(:vwap, :float)
    field(:average, :float)
    field(:volume, :float)
    field(:rate, :float)

    timestamps(type: :utc_datetime)
  end

  def changeset(params) do
    %__MODULE__{}
    |> cast(params, @fields)
    |> validate_required(@fields)
  end
end
                        </code></pre>

                        <ul>
                            <li>workers + tests</li>
                            <li>live view + tests</li>
                            <li>js hooks and chart.js</li>
                        </ul>
                    </div>
                </div>
    </body>

</html>
